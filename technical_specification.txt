

# Technical Specification

## Project: `remote_hosts_sync`

### Neovim Remote Hosts & Auto-Deployment System

---

# 1. Objective

Develop a production-grade Neovim plugin that provides functionality equivalent to Remote Hosts and automatic deployment features found in JetBrains IDEs such as PhpStorm and WebStorm.

The plugin must:

* Automatically upload files on save
* Support full project synchronization
* Provide remote file browsing via TUI
* Handle file conflicts with diff preview
* Maintain persistent SSH connection
* Support SSH password authentication
* Operate asynchronously without blocking Neovim
* Support Linux, macOS, and Windows via WSL
* Be implemented entirely in Lua for Neovim ≥ 0.9

---

# 2. Supported Protocols

Mandatory support:

* SSH
* SFTP
* rsync over SSH

Not supported:

* FTP
* FTPS

---

# 3. Configuration System

## 3.1 Configuration Files

Project-level configuration:

```
.remote_hosts_sync.toml
```

Global configuration:

```
~/.config/nvim/remote_hosts_sync.toml
```

Project configuration overrides global configuration.

---

## 3.2 Configuration Schema

```toml
active_host = "production"

[[hosts]]
name = "production"
type = "sftp"
host = "example.com"
port = 22
user = "deploy"

# Authentication (one required)
ssh_key = "~/.ssh/id_rsa"
# OR
password = "secret"
# OR
password_env = "DEPLOY_PASSWORD"

remote_path = "/var/www/project"

excludes_local = ["node_modules/", ".git/"]
excludes_remote = ["cache/", "logs/"]
```

---

## 3.3 Host Rules

* Maximum 10 hosts per project
* Only ONE active host at a time
* Active host receives automatic uploads
* Non-active hosts may be browsed but not auto-synced

---

# 4. Authentication Requirements

## 4.1 Mandatory Authentication Support

The system MUST support:

* SSH key authentication
* ssh-agent authentication
* SSH password authentication (REQUIRED)

---

## 4.2 Password Handling Rules

Passwords:

* MAY be stored in TOML
* MUST NOT be logged
* MUST NOT appear in debug output
* MUST NOT appear in process list (ps/top)
* MUST NOT be embedded in command arguments

If `password_env` is defined:

* The password MUST be read using `os.getenv`
* The environment variable MUST NOT be logged

---

## 4.3 Password Execution Strategy

Password MUST be provided securely via environment injection.

Permitted pattern:

```
SSHPASS=<password> sshpass -e ssh ...
```

Implementation constraints:

* Password must be passed via environment table in plenary.job
* Never concatenate password into command string
* All arguments must be escaped

Interactive PTY handling is permitted but not required.

---

# 5. Persistent Connection Management

## 5.1 Persistent SSH Session

The system MUST:

* Maintain a persistent SSH session
* Detect connection drop
* Attempt reconnect every 5 seconds
* Stop reconnect after configurable retry limit (default: 5)
* Expose connection state to UI

---

## 5.2 Reconnect Policy

On connection failure:

1. Mark state as disconnected
2. Start timer
3. Retry every 5 seconds
4. Stop after max attempts
5. Log each attempt

---

# 6. Automatic Upload on Save

## 6.1 Trigger

Use:

```
autocmd BufWritePost
```

---

## 6.2 Execution Flow

On file save:

1. Verify active host exists
2. Verify file not excluded
3. Resolve absolute local path
4. Compute remote target path
5. Check remote modification time
6. Detect conflict
7. If no conflict, upload via SFTP
8. Log result

---

## 6.3 Conflict Detection

Conflict occurs if:

* Remote file exists AND
* Remote mtime > local mtime

On conflict, user must be prompted with:

* Cancel
* Overwrite remote
* Show diff

No automatic overwrite allowed when conflict detected.

---

# 7. Diff Handling

On "Show diff":

1. Download remote file to temporary path
2. Open vertical diff using:

```
vimdiff
```

Local file must not be overwritten.

Temporary file must be cleaned up after session.

---

# 8. Manual Commands

## 8.1 RemoteSync

Full project synchronization using rsync.

Requirements:

* Use flags:

  * `--archive`
  * `--delete`
  * `--checksum`
* Respect excludes_local
* Provide dry-run mode
* Display summary after completion
* Operate asynchronously

---

## 8.2 RemotePush

Upload entire selected directory via rsync.

---

## 8.3 RemoteFetch

Download selected directory via rsync.

---

# 9. Remote File Tree (TUI)

## 9.1 Requirements

* Lazy directory loading
* Asynchronous listing
* Directory caching
* No full-tree redraw on single change
* Keyboard-driven navigation

---

## 9.2 Keybindings

| Key   | Action            |
| ----- | ----------------- |
| Enter | Open file         |
| r     | Refresh directory |
| u     | Upload file       |
| d     | Download file     |
| q     | Close tree        |

---

## 9.3 UI Stack

Mandatory:

* nui.nvim for tree UI
* plenary.nvim for async jobs

Telescope must NOT be used for tree rendering.

---

# 10. Logging

Log file:

```
.remote_hosts_sync.log
```

Must log:

* Upload
* Download
* Sync
* Reconnect attempts
* Errors

Must NOT log:

* Passwords
* Environment variables
* Raw command strings containing secrets

---

# 11. Internal Architecture

Required structure:

```
remote_hosts_sync/
├── lua/
│   ├── config/
│   ├── core/
│   ├── transport/
│   ├── sync/
│   ├── tui/
│   └── commands.lua
├── plugin/
│   └── remote_hosts_sync.lua
```

---

## 11.1 Required Modules

### core/state.lua

* Store active host
* Store connection object
* Store sync state
* Store reconnect state

### core/logger.lua

* Safe logging
* Secret redaction

### config/loader.lua

* Parse TOML
* Validate schema

### transport/ssh.lua

* Persistent session
* Reconnect logic
* Password injection

### transport/sftp.lua

* Upload file
* Download file
* List directory
* Stat file

### transport/rsync.lua

* Full sync
* Push
* Fetch
* Dry-run mode

### sync/watcher.lua

* BufWritePost handler

### tui/tree.lua

* Render tree
* Lazy expand
* Trigger actions

---

# 12. Asynchronous Requirements

All remote operations MUST:

* Use plenary.job or vim.loop
* Never block UI
* Handle stdout/stderr asynchronously
* Propagate errors via callback or promise-style pattern

Blocking system calls are forbidden.

---

# 13. Security Constraints

* All shell arguments must be escaped
* No string concatenation for command building
* Use array-based argument passing
* Validate remote paths
* Prevent command injection
* Never execute arbitrary user input directly

---

# 14. Cross-Platform Constraints

Supported environments:

* Linux
* macOS
* Windows via WSL

The plugin must assume Unix-like shell environment.

Windows native SSH is not required.

---

# 15. Error Handling

The plugin must gracefully handle:

* Authentication failure
* Permission denied
* File not found
* SSH timeout
* Network interruption
* Rsync failure

The plugin must never crash Neovim.

All errors must be logged and surfaced to user.

---

# 16. Performance Constraints

* No UI blocking
* No full-tree redraw when updating single node
* Large sync must display progress
* Directory cache must reduce repeated remote calls

---

# 17. Acceptance Criteria

The plugin is considered complete only if:

* Saving a file uploads it immediately to active host
* Password authentication works reliably
* Full project sync works with checksum validation
* Conflict detection prevents unsafe overwrite
* Diff preview opens correctly
* Remote tree loads lazily and asynchronously
* SSH reconnects automatically
* Password never appears in logs or process list
* UI remains responsive during all operations



